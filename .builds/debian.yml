image: debian/stable

packages:
  - dh-virtualenv
  - virtualenv
  - devscripts
#  - git-buildpackage
  - debhelper-compat
  - dwz
  - python3-dev
  - libffi-dev
  - cython3

environment:
  DEBFULLNAME: IGImonster
  EMAIL: igimonster@mailbox.org
  PLUGINS: facebook signal telegram skype hackernews mattermost steam discord

artifacts:
  - slidge-debian-amd64.tar
  - slidge-latest-amd64.deb

tasks:
  - version: |
      cd slidge
      echo VER=$(date +"%Y%m%d")-git-$(git rev-parse HEAD | cut -c1-5) >> ~/.buildenv
      for TAG in $(git tag --points-at HEAD); do
        if [[ $TAG == v* ]] ; then
          echo VER=$(echo $TAG | cut -c2-) >> ~/.buildenv
        fi
      done
  - export-requirements: |
      pip install poetry
      cd slidge
      ~/.local/bin/poetry export $(for p in $PLUGINS; do echo -n "-E $p "; done) -o requirements.txt
  - generate-plugin-files: |
      cd slidge/debian
      mkdir systemd
      mkdir -p etc/conf.d
      for PLUGIN in $PLUGINS; do
        sed "s/--PLUGIN--/$PLUGIN/" tpl.conf > etc/$PLUGIN.conf.example
        sed "s/--PLUGIN--/$PLUGIN/" tpl.service > systemd/slidge-$PLUGIN.service
      done
      echo "socket=/var/run/signald/signald.sock" >> etc/signal.conf
  - build: |
      cd slidge
      cp ./LICENSE ./debian/copyright
      debchange --create "Autogenerated" --newversion=$VER --package "slidge"
      # git checkout -B debian-package
      # gbp dch --release --debian-branch debian-package
      dpkg-buildpackage -us -uc -b
  - test: |
      sudo apt-get install ./slidge_${VER}_amd64.deb -y
      ls -la /usr/lib/slidge*
      sudo ls -la /etc/slidge*
      ls -l /etc/systemd/system/slidge*
      cat /etc/systemd/system/slidge-signal.service
      slidge --help
      sudo systemctl enable --now slidge-mattermost
      sleep 5
      sudo journalctl -u slidge-mattermost --since yesterday
  - tar: |
      tar cf slidge-debian-amd64.tar slidge-* slidge_*
      mv slidge_${VER}_amd64.deb slidge-latest-amd64.deb
